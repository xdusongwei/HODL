{% set state = store.state %}
{% set store_config = store.store_config %}
{% set total_chips = state.plan.total_chips %}
{% set row_tool = ProfitRowTool(store=store) %}
<div>
    <p class="mb-0 mt-2">
        <span class="fs-4">{{ store_config.name }}</span>
        {% if state.quote_rate is not none %}
        <span class="fs-6 fw-bold {{ 'text-success' if state.quote_rate >= 0 else 'text-danger' }}">
            {{ FMT.pretty_price(state.quote_latest_price, config=store_config) + '(%+.2f%%)'|format(state.quote_rate * 100) }}
        </span>
        {% endif %}
    </p>
    <p class="mb-0">[{{ store_config.region }}]{{ store_config.symbol }}<span class="text-muted ms-2">{{ FMT.pretty_dt(state.quote_time, region=store_config.region, with_year=True, with_tz=True)[:24] }}</span></p>
    <p class="text-muted fs-6">
        <span class="me-2">
            市场:{{ state.market_status_display }}
        </span>
        <span class="me-2">
            交易:{{ state.trade_broker_display }}
        </span>
        <span>
            行情:{{ state.quote_broker_display }}
        </span>
    </p>
    {% set thread_mixin = store %}
    {% include 'thread_mixin.html' %}
    <p>
        {% if row_tool.has_table %}
            <a class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse"
               role="button" aria-expanded="false"
               href="#report-{{ store_config.broker }}-{{ store_config.symbol }}"
               aria-controls="report-{{ store_config.broker }}-{{ store_config.symbol }}"
            >更多({{ row_tool.filled_level }}/{{ row_tool.rows|length }})</a>
            <div class="collapse" id="report-{{ store_config.broker }}-{{ store_config.symbol }}">
                <div class="table-responsive-md">
                  <table class="table table-striped table-hover table-dark align-middle table-sm">
                    <caption>
                        {% if row_tool.buy_percent %}
                        <span>
                            距买回价 {{ FMT.factor_to_percent(row_tool.buy_percent, fmt="{:.1%}") }};
                        </span>
                        {% endif %}
                        {% if row_tool.sell_percent %}
                        <span>
                            距下次卖出 {{ FMT.factor_to_percent(row_tool.sell_percent, fmt="{:.1%}") }};
                        </span>
                        {% endif %}
                        {% set cog = state.plan.cog(precision=store_config.precision) %}
                        {% if cog is not none %}
                        <span>
                            卖出部分均价 {{ FMT.pretty_price(cog, config=store_config) }};
                        </span>
                        {% endif %}
                    </caption>
                    <thead>
                    <tr>
                        <th scope="col" class="text-end">#</th>
                        <th scope="col">状态</th>
                        <th scope="col" class="text-end">卖出价</th>
                        <th scope="col" class="text-end">卖出比</th>
                        <th scope="col" class="text-end">买回价</th>
                        <th scope="col" class="text-end">预测收益</th>
                        <th scope="col" class="text-end d-none d-sm-table-cell">收益/本金</th>
                    </tr>
                    </thead>
                      <tbody>
                      {% for row in row_tool.rows %}
                        {% set earning_forecast = row_tool.earning_forecast(row.total_rate) %}
                        <tr>
                            <th scope="row" class="text-end">{{ loop.index }}</th>
                            {% if row_tool.filled_level >= loop.index %}
                                <td>✅</td>
                            {% else %}
                                <td>⏳</td>
                            {% endif %}
                            <td class="text-end">
                                {{ FMT.pretty_price(row.sell_at, config=store_config) }}
                            </td>
                            <td class="text-end">
                                {{ FMT.factor_to_percent(row.shares / total_chips, fmt="{:.1%}") }}
                            </td>
                            <td class="text-end">
                                {{ FMT.pretty_price(row.buy_at, config=store_config) }}
                            </td>
                            <td class="text-end">
                                {{ FMT.pretty_price(earning_forecast, config=store_config, only_int=True) }}
                            </td>
                            <td class="text-end d-none d-sm-table-cell">
                                {{ '%.2f%%'|format(row.total_rate * 100 - 100) }}
                            </td>
                        </tr>
                      {% endfor %}
                      </tbody>
                  </table>
                </div>
            </div>
        {% endif %}
    </p>
</div>